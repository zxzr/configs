"use strict";function _possibleConstructorReturn(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!b||"object"!=typeof b&&"function"!=typeof b?a:b}function _inherits(a,b){if("function"!=typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}();!function(){function a(a,b){chrome.windows.update(a.windowId,{focused:!0},function(){chrome.tabs.update(a.id,{active:!0,url:b?b:a.url})})}function b(b){chrome.tabs.query({},function(c){for(var d=!1,e=0;e<c.length;e++){var f=c[e];if(f.url==b){d=!0,a(f);break}}d||chrome.tabs.query({url:"chrome://newtab/"},function(c){c=c.filter(function(a){return!a.incognito}),c.length>0?a(c[0],b):chrome.windows.getAll({},function(a){for(var c=void 0,d=0;d<a.length;d++){var e=a[d];if(!e.incognito){c=e;break}}c?chrome.tabs.create({url:b,windowId:c.id,active:!0}):chrome.windows.create({url:b})})})})}function c(a,b,c){return new Promise(function(c,d){var e=new XMLHttpRequest,f=setTimeout(function(){d()},1e4);e.open(b||"GET",a),e.onreadystatechange=function(){4==this.readyState&&(clearTimeout(f),c(e.responseText))},e.send()})}function d(a){o.getAsync(B,function(b){for(var c in E)E.hasOwnProperty(c)&&void 0===b[c]&&(b[c]=E[c]);E=b,a&&a(b)},E)}function e(a,b){for(var c in a)a.hasOwnProperty(c)&&(E[c]=a[c]);o.setAsync(B,E,b)}var f=function(){function a(){_classCallCheck(this,a),this.handlers={}}return _createClass(a,[{key:"_addEventListener",value:function(a,b){(this.handlers[a]||(this.handlers[a]=[])).push(b)}},{key:"fire",value:function(a,b){if(this.handlers[a])for(var c=this.handlers[a],d=c.length,e=0;d>e;e++){var f=c[e];f&&f(b)}}},{key:"on",value:function(a,b){var c=Object.prototype.toString.call(a);if("[object String]"==c)this._addEventListener(a,b);else if("[object Array]"==c)for(var d=0,e=a.length;e>d;d++)this._addEventListener(a[d],b);else{if("[object Object]"!=c)throw Error("arguments error");for(var f in a)a.hasOwnProperty(f)&&this._addEventListener(f,a[f])}}},{key:"un",value:function(a,b){this.handlers[a]&&this.handlers[name].filer(function(a){return a!=b})}}]),a}(),g=new(function(a){function b(){_classCallCheck(this,b);var a=_possibleConstructorReturn(this,Object.getPrototypeOf(b).call(this));return a._enable=chrome.abp&&chrome.abp.onBlockedCountChanged,a._enableBlack=a.enable&&chrome.abp.onBlackRuleChanged,a._enable&&chrome.abp.onBlockedCountChanged.addListener(function(b){a.getBlockedCount(b,function(c){isNaN(c)||0>=+c||a.fire("onBlockedCountChanged",{tabId:+b,count:c})})}),a.enable&&chrome.abp.onWhiteRuleChanged.addListener(function(){a.fire("onWhiteRuleChanged")}),a.enableBlack&&chrome.abp.onBlackRuleChanged.addListener(function(){a.fire("onBlackRuleChanged")}),a}return _inherits(b,a),_createClass(b,[{key:"enableBlack",get:function(){return this._enableBlack}},{key:"enable",get:function(){return this._enable}}]),_createClass(b,[{key:"getBlockedCount",value:function(a,b){var c="";this.enable?chrome.abp.getBlockedCount(a+"",b):b(c)}},{key:"setWhiteRule",value:function(a,b,c){c="function"==typeof c?c:function(){};var d=Object.prototype.toString.call(a);a="[object Array]"==d?a:[a],this.enable?chrome.abp.setWhiteRule(a,b,c):c("success")}},{key:"setBlackRule",value:function(a,b,c){c="function"==typeof c?c:function(){};var d=Object.prototype.toString.call(a);a="[object Array]"==d?a:[a],this.enableBlack?chrome.abp.setBlackRule(a,b,c):c("success")}},{key:"getWhiteRule",value:function(a){var b=[];return this.enable?chrome.abp.getWhiteRule(a):a(b)}},{key:"getBlackRule",value:function(a){var b=[];return this.enableBlack?chrome.abp.getBlackRule(a):a(b)}},{key:"setLevel",value:function(a){this.enable&&chrome.abp.setLevel(a)}},{key:"getLevel",value:function(a){var b="2";return this.enable?chrome.abp.getLevel(function(b){a(isNaN(b)||b>2||"0"==b?"2":b)}):a(b)}},{key:"setRule",value:function(a,b){this.enable&&chrome.abp.setRule(a,b)}}]),b}(f)),h=new(function(){function a(){_classCallCheck(this,a),this._contentEventManager=null,this._extensionEventManger=null}return _createClass(a,[{key:"extensionEventManger",get:function(){return this._extensionEventManger},set:function(a){this._extensionEventManger=a}},{key:"contentEventManager",set:function(a){this._contentEventManager=a},get:function(){return this._contentEventManager}}]),_createClass(a,[{key:"_addContentLister",value:function(){var a=this;this.contentEventManager=new f,chrome.extension.onMessage.addListener(function(b,c,d){var e=b.type,f=b.data;a.contentEventManager&&a.contentEventManager.fire(e,{data:f,resp:d})})}},{key:"_addExtensionLister",value:function(){this.extensionEventManger=new f}},{key:"sendToExtension",value:function(a,b,c){chrome.extension.sendMessage({type:a,data:b},c)}},{key:"sendToContent",value:function(a,b,c,d){chrome.tabs.sendMessage(a,{type:b,data:c},d)}},{key:"addContentLister",value:function(a,b){this.contentEventManager||this._addContentLister(),this.contentEventManager.on(a,b)}},{key:"addExtensionLister",value:function(a,b){this.extensionEventManger||this._addExtensionLister(),this.extensionEventManger.on(a,b)}}]),a}()),i="#5badf8",j=new(function(){function a(){var b=this;_classCallCheck(this,a),window._setBadge=function(a,c,d){b.setBadge(a,c,d)}}return _createClass(a,[{key:"isValidCount",value:function(a){return!isNaN(a)&&+a>0}},{key:"hide",value:function(a){chrome.browserAction.disable(a)}},{key:"show",value:function(a){chrome.browserAction.enable(a)}},{key:"setBadge",value:function(a,b,c){this.isValidCount(b)||""==b?(b=b>99?"99+":b,chrome.browserAction.setBadgeBackgroundColor({tabId:a,color:i}),chrome.browserAction.setBadgeText({tabId:a,text:b+""}),c&&this.show(a)):this.hide(a)}},{key:"resumeBadge",value:function(){var a=this;chrome.tabs.query({},function(b){b.forEach(function(b){var c=b.id;g.getBlockedCount(c,function(b){a.isValidCount(b)&&a.setBadge(c,b,!0)})})})}},{key:"clearBadge",value:function(){var a=this;chrome.tabs.query({},function(b){b.forEach(function(b){a.setBadge(b.id,"")})})}}]),a}()),k={},l={},m=!0,n=!!chrome.storage;!function(){try{m=!!window.localStorage}catch(a){m=!1}}();var o=new(function(){function a(){_classCallCheck(this,a)}return _createClass(a,[{key:"getSync",value:function(a,b){return m?localStorage[a]||b:k[a]||b}},{key:"setSync",value:function(a,b){if(m)return localStorage[a]=b;var c=Object.prototype.toString.call(b);switch(c){case"[object Object]":case"[object Array]":b=JSON.stringify(b);break;default:b+=""}k[a]=b}},{key:"remSync",value:function(a){m?localStorage.removeItem(a):delete k[a]}},{key:"getAsync",value:function(a,b,c){n?chrome.storage.local.get(a,function(d){window.__IS_DEBUG_MODE__&&console.log("getAsync",{key:a,val:d[a]});var e=(d||{})[a];b&&b(void 0!==e?e:c)}):b&&b(void 0!==l[a]?l[a]:c)}},{key:"setAsync",value:function(a,b,c){if(window.__IS_DEBUG_MODE__&&console.log("setAsync",{key:a,val:b}),n){var d={};d[a]=b,chrome.storage.local.set(d,c)}else l[a]=b,c&&c(b)}},{key:"remAsync",value:function(a,b){n?chrome.storage.local.remove(a,b):delete l[a]}}]),a}()),p="-----BEGIN PUBLIC KEY-----\nMIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQC+gDNj4Ag6MvL+yfrHdX4qeQFa\nJ1epFQXBmOsSWBKoXF5haWM6d5gtETO8FRC6RcwpEKZyy7iSyZ70m4EtGMNQvoOT\ngHvIceb5GHGBqqMawTjI71P69DYBjWZoLGt/IX3YJixub8nfTG5KW720LXtT/dXn\nPAN9jy21h+TfcXvDgwIDAQAB\n-----END PUBLIC KEY-----",q=new(function(){function a(){_classCallCheck(this,a)}return _createClass(a,[{key:"rsaVerify",value:function(a,b){var c=KEYUTIL.getKey(p);return c.verifyString(a,b)}},{key:"md5Verify",value:function(a,b){return b==hex_md5(a)}}]),a}()),r="http://bk.xhcdn.cn/config.json",s="http://lg.xhcdn.cn/t.html",t={FETCH:"fetch",VERIFY:"verify"},u={},v=216e5,w="storage_key_config_stamp",x="storage_key_rule_config",y="storage_key_abp_rule",z="storage_key_add_rule",A=new(function(){function a(){_classCallCheck(this,a)}return _createClass(a,[{key:"isValid",value:function(a){return a&&a.length>20&&a.split("\n").length>1}},{key:"_dotting",value:function(a,b){var c=new Image,d=["f=adb","t="+a,"r="+Math.random(),"u="+encodeURIComponent(b)].join("&");c.src=[s,d].join("?")}},{key:"_getCacheRule",value:function(a,b){var c=this;o.getAsync(a.storageKey,function(d){c.isValid(d)?b(d):c._fetchRule(a,b)})}},{key:"_fetchRule",value:function(a,b){var d=this;c(a.url,"GET",{}).then(function(c){q.md5Verify(c,a.md5)?(b(c),o.setAsync(a.storageKey,c)):d._dotting(t.VERIFY,a.url)},function(){d._dotting(t.FETCH,a.url)})}},{key:"_fetchConfigs",value:function(a,b){var d=this;a=a||{},a.normal=a.normal||{},a.strong=a.strong||{},c(r,"GET",{}).then(function(c){var e=u;try{e=JSON.parse(c);var f=e.normal||{},g=e.strong||{},h=""+f.url+f.md5+g.url+g.md5,i=q.rsaVerify(h,e.sign);i?(o.setAsync(w,Date.now()),o.setAsync(x,e)):(d._dotting(t.VERIFY,r),e=a)}catch(j){d._dotting(t.FETCH,r)}b(e)},function(){d._dotting(t.FETCH,r)})}},{key:"getConfigs",value:function(a){var b=this;o.getAsync(w,function(c){o.getAsync(x,function(d){var e=Date.now(),f=e-(c||0)>v;!isNaN(c)&&!f&&d&&d.normal&&d.strong?a(d):b._fetchConfigs(d,a)},u)},0)}},{key:"getRule",value:function(a,b,c){var d=this;b.storageKey=a,this._getCacheRule(b,function(a){c(a);var e=!q.md5Verify(a,b.md5),f=Math.floor(100*Math.random())<=b.weight;e&&f&&d._fetchRule(b,c)})}},{key:"getAbpRule",value:function(a,b){this.getRule(y,a,b)}},{key:"getAddRule",value:function(a,b){this.getRule(z,a,b)}}]),a}());window.__IS_DEBUG_MODE__=!1;var B="storage_key_settings",C={FLAG_ADD_RULE:"0",FLAG_DEL_RULE:"1"},D={LEVEL_EMPTY:"0",LEVEL_NORMAL:"1",LEVEL_STRONG:"2"},E={isFirstRun:!0,badgeEnable:!0,level:void 0,whiteRule:[],blackRule:[]},F=new(function(){function a(){_classCallCheck(this,a)}return _createClass(a,[{key:"ready",value:function b(a){var b=!1,c=function(){b||(b=!0,a())};"complete"==document.readyState?a():(this.addListener(window,"DOMContentLoaded",c),this.addListener(window,"load",c))}},{key:"getAttr",value:function(a,b){return a.getAttribute(b)}},{key:"setStyles",value:function(a,b){for(var c in b)b.hasOwnProperty(c)&&(a.style[c]=b[c])}},{key:"show",value:function(a,b){"[object array]"!=Object.prototype.toString.call(a).toLowerCase()&&(a=[a]);for(var c=0;c<a.length;c++)this.setStyles(a[c],{display:b||"block"})}},{key:"hide",value:function(a,b){"[object array]"!=Object.prototype.toString.call(a).toLowerCase()&&(a=[a]);for(var c=0;c<a.length;c++)this.setStyles(a[c],{display:b||"none"})}},{key:"findParent",value:function(a,b){for(var c=a.parentNode;c!=document.body&&-1===(c.className||"").indexOf(b);)c=c.parentNode;return c}},{key:"queryAll",value:function(a){return document.querySelectorAll(a)}},{key:"query",value:function(a,b){return b=b||document,b.querySelector(a)}},{key:"html",value:function(a){return a.innerHTML}},{key:"setText",value:function(a,b){a.innerText=b}},{key:"addListener",value:function(a,b,c){a.addEventListener(b,c)}}]),a}());F.ready(function(){function a(){chrome.tabs.query({url:o},function(a){a.forEach(function(a){chrome.tabs.reload(a.id)})})}function c(){chrome.tabs.query({url:o},function(a){var b=[];a.forEach(function(a){b.push(a.id)}),chrome.tabs.remove(b)})}function f(a,b){A.getConfigs(function(c){d(function(d){var e=a||d.level,f=d.whiteRule||[],h=d.blackRule||[];g.setLevel(e),b&&g.setWhiteRule(f,C.FLAG_ADD_RULE),b&&g.setBlackRule(h,C.FLAG_ADD_RULE),e==D.LEVEL_NORMAL?A.getAddRule(c.normal,function(a){A.isValid(a)&&g.setRule(e,a)}):e==D.LEVEL_STRONG?A.getAbpRule(c.strong,function(a){A.isValid(a)&&g.setRule(e,a)}):g.setRule(D.LEVEL_EMPTY,"")})})}function i(a){var b=a.tabId,c=m[b];c&&clearTimeout(c),m[b]=setTimeout(function(){m[b]=null,j.isValidCount(a.count)?(j.setBadge(b,l?a.count:"",!0),h.sendToExtension("onBlockedCountChanged",a)):j.hide(b)},n)}function k(a){var b=m[a];b&&clearTimeout(b),m[a]=null}var l=!1,m={},n=100,o=chrome.extension.getURL("option.html");return g.enable||__IS_DEBUG_MODE__?(a(),void d(function(a){l=a.badgeEnable;var c=a.level;void 0==c?g.getLevel(function(a){e({level:a},function(){f(a,!0)})}):f(c,!0),g.on("onBlockedCountChanged",function(a){i(a)}),g.on("onWhiteRuleChanged",function(){g.getWhiteRule(function(a){e({whiteRule:a},function(){h.sendToExtension("onWhiteRuleChanged","")})})}),g.on("onBlackRuleChanged",function(){g.getBlackRule(function(a){e({blackRule:a},function(){h.sendToExtension("onBlackRuleChanged","")})})}),chrome.tabs.onReplaced.addListener(function(a,b){k(b)}),chrome.tabs.onRemoved.addListener(function(a,b){k(a)}),chrome.extension.onMessage.addListener(function(a,c,h){var i=a.type,k=a.data;switch(i){case"getNativeConfig":d(function(a){g.getWhiteRule(function(b){g.getBlackRule(function(c){h({level:a.level,whiteRule:b,blackRule:c,enableBlack:g.enableBlack})})})});break;case"setLevel":e({level:k},function(){f(k)});break;case"delWhite":g.setWhiteRule(k.url,C.FLAG_DEL_RULE,h);break;case"delBlack":g.setBlackRule(k.url,C.FLAG_DEL_RULE,h);break;case"addWhite":k.id&&j.hide(k.id),g.setWhiteRule(k.url,C.FLAG_ADD_RULE,function(a){setTimeout(function(){h(a)},500)});break;case"addBlack":g.setBlackRule(k.url,C.FLAG_ADD_RULE,h);break;case"storeWhite":e({whiteRule:k});break;case"storeBlack":e({blackRule:k});break;case"getBadgeText":g.getBlockedCount(k,h);break;case"enableBadgeText":l=k,l?j.resumeBadge():j.clearBadge(),e({badgeEnable:k});break;case"openUrl":b(k)}return!0})})):void c()})}();